<p-toast position="top-right"></p-toast>
<div class="patients-container">
  <div class="header-section">
    <h1>Patients Management</h1>
    <p-button
      label="Add New Patient"
      icon="pi pi-user-plus"
      styleClass="p-button-raised"
    ></p-button>
  </div>

  <div class="container-box">
    <div class="section-title">Patient Registration</div>

    <div class="patient-type">
      <div class="form-check">
        <input
          class="form-check-input"
          type="radio"
          id="NewPatient"
          name="patientType"
          [(ngModel)]="isExistingPatient"
          [value]="false"
        />
        <label class="form-check-label">New Patient</label>
      </div>
      <div class="form-check">
        <input
          class="form-check-input"
          type="radio"
          name="patientType"
          id="ExistingPatient"
          [(ngModel)]="isExistingPatient"
          [value]="true"
        />
        <label class="form-check-label">Existing Patient</label>
      </div>
    </div>

    <div class="section-title" *ngIf="!isExistingPatient">Patient Details</div>
    <form #newUserForm="ngForm" (ngSubmit)="onSubmit(newUserForm)" (ngReset)="onReset(newUserForm)">
      <div class="row g-3" *ngIf="!isExistingPatient">
        <div class="col-md-2">
          <label class="form-label">Surname <span class="text-danger">*</span></label>
          <input
            class="form-control"
            [(ngModel)]="newPatient.lastName"
            name="lastName"
            placeholder="Surname"
            required
            #lastName="ngModel"
            [class.is-invalid]="lastName.invalid && (lastName.dirty || lastName.touched)"
          />
          <div
            *ngIf="lastName.invalid && (lastName.dirty || lastName.touched)"
            class="invalid-feedback"
          >
            Surname is required.
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">First Name <span class="text-danger">*</span></label>
          <input
            class="form-control"
            [(ngModel)]="newPatient.firstName"
            name="firstName"
            placeholder="First Name"
            required
            #firstName="ngModel"
            [class.is-invalid]="firstName.invalid && (firstName.dirty || firstName.touched)"
          />
          <div
            *ngIf="firstName.invalid && (firstName.dirty || firstName.touched)"
            class="invalid-feedback"
          >
            First Name is required.
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Father Name</label>
          <input class="form-control" [(ngModel)]="newPatient.fatherName" name="fatherName" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Age <span class="text-danger">*</span></label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="newPatient.age"
            name="age"
            required
            #age="ngModel"
            [class.is-invalid]="age.invalid && (age.dirty || age.touched)"
          />
          <div *ngIf="age.invalid && (age.dirty || age.touched)" class="invalid-feedback">
            Age is required.
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Weight</label>
          <input type="number" class="form-control" [(ngModel)]="newPatient.weight" name="weight" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
          <input
            class="form-control"
            [(ngModel)]="newPatient.phoneNumber"
            name="phoneNumber"
            required
            pattern="^[0-9]{10}$"
            #phoneNumber="ngModel"
            [class.is-invalid]="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)"
          />
          <div
            *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)"
            class="invalid-feedback"
          >
            <div *ngIf="phoneNumber.errors?.['required']">Mobile Number is required.</div>
            <div *ngIf="phoneNumber.errors?.['pattern']">Must be 10 digits.</div>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Gender <span class="text-danger">*</span></label>
          <select
            class="form-select"
            [(ngModel)]="newPatient.gender"
            name="gender"
            required
            #gender="ngModel"
            [class.is-invalid]="gender.invalid && (gender.dirty || gender.touched)"
          >
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
          <div *ngIf="gender.invalid && (gender.dirty || gender.touched)" class="invalid-feedback">
            Gender is required.
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Blood Group</label>
          <select class="form-select" [(ngModel)]="newPatient.bloodGroup" name="bloodGroup">
            <option value="">Select</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Marital Status</label>
          <select class="form-select" [(ngModel)]="newPatient.maritalStatus" name="maritalStatus">
            <option value="">Select</option>
            <option value="Married">Married</option>
            <option value="Single">Single</option>
          </select>
        </div>
        <div class="col-md-4" style="display: none">
          <label class="form-label">Take Picture</label>
          <div class="action-bar">
            <button type="button" class="btn btn-primary px-4">Take Picture</button>
            <button type="button" class="btn btn-outline-secondary px-4">Clear Picture</button>
          </div>
        </div>
        <div class="section-title">Patient Address</div>

        <div class="col-md-4">
          <label class="form-label">State <span class="text-danger">*</span></label>

          <select
            class="form-select"
            [ngModel]="newPatient.address.state"
            required
            (ngModelChange)="newPatient.address.state = $event; onStateChange()"
            name="state"
            #state="ngModel"
            [class.is-invalid]="state.invalid && (state.dirty || state.touched)"
          >
            <option value="">Select state</option>
            <option *ngFor="let state of states" [value]="state.stateLookupId">
              {{ state.stateName }}
            </option>
          </select>
          <div *ngIf="state.invalid && (state.dirty || state.touched)" class="invalid-feedback">
            State is required.
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">District <span class="text-danger">*</span></label>
          <select
            class="form-select"
            required
            [ngModel]="newPatient.address.district"
            (ngModelChange)="newPatient.address.district = $event; onDistrictChange()"
            name="district"
            #district="ngModel"
            [class.is-invalid]="district.invalid && (district.dirty || district.touched)"
          >
            <option value="">Select district</option>
            <option *ngFor="let district of districts" [value]="district.districtLookupId">
              {{ district.districtName }}
            </option>
          </select>
          <div
            *ngIf="district.invalid && (district.dirty || district.touched)"
            class="invalid-feedback"
          >
            District is required.
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Mandal </label>
          <select
            class="form-select"
            [(ngModel)]="newPatient.address.mandal"
            required
            name="mandal"
            #mandal="ngModel"
            [class.is-invalid]="mandal.invalid && (mandal.dirty || mandal.touched)"
          >
            <option value="">Select mandal</option>
            <option *ngFor="let mandal of mandals" [value]="mandal.mandalLookupId">
              {{ mandal.mandalName }}
            </option>
          </select>
          <div *ngIf="mandal.invalid && (mandal.dirty || mandal.touched)" class="invalid-feedback">
            Mandal is required.
          </div>
        </div>
        <!-- Removed duplicate Mandal select -->
        <div class="col-md-2">
          <label class="form-label">City /Village </label>
          <input class="form-control" [(ngModel)]="newPatient.address.city" name="city" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Street </label>
          <input class="form-control" [(ngModel)]="newPatient.address.street" name="street" />
        </div>
      </div>

      <div class="action-bar" *ngIf="!isExistingPatient">
        <button type="submit" class="btn btn-primary px-4" [disabled]="newUserForm.invalid">
          Save Patient
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary px-4"
          (click)="onClearForm(); newUserForm.resetForm()"
        >
          Clear
        </button>
      </div>
    </form>
  </div>

  <p-card class="hidden" *ngIf="filteredPatients.length > 0 && isExistingPatient">
    <div class="table-header d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2 w-100">
        <input
          pInputText
          type="text"
          class="p-inputtext-sm flex-grow-1"
          placeholder="MR Number / First / Surname / Old EnrollmentId"
          [(ngModel)]="searchText"
          (keyup.enter)="onSearch()"
          style="margin-bottom: 0"
        />

        <button
          pButton
          type="button"
          label="Search"
          icon="pi pi-search"
          class="p-button-sm p-button-primary"
          (click)="onSearch()"
        ></button>
      </div>
    </div>
    <div style="display: none">
      <p-table
        [value]="filteredPatients"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-striped hidden"
        [tableStyle]="{ display: 'none' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Patient ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Date of Birth</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-patient>
          <tr>
            <td>{{ patient.patient_id }}</td>
            <td>{{ patient.first_name }} {{ patient.last_name || '' }}</td>
            <td>{{ calculateAge(patient.dob) }}</td>
            <td>{{ patient.gender || 'N/A' }}</td>
            <td>{{ patient.phone || 'N/A' }}</td>
            <td>{{ patient.address || 'N/A' }}</td>
            <td>
              {{ patient.dob ? (patient.dob | date: 'shortDate') : 'N/A' }}
            </td>
            <td>
              <p-button
                icon="pi pi-eye"
                [text]="true"
                severity="info"
                [rounded]="true"
                title="View Details"
              ></p-button>
              <p-button
                icon="pi pi-pencil"
                [text]="true"
                severity="secondary"
                [rounded]="true"
                title="Edit"
              ></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-card>

  <div class="soap-container" style="display: none">
    <div class="soap-header" *ngIf="!isExistingPatient">SOAP Notes - front Office or volunteer</div>
    <div class="soap-header" *ngIf="isExistingPatient">SOAP Notes - Doctor Consultation</div>

    <div class="box-header with-border p-0 border-bottom-blue">
      <h4 class="font-semibold">Patient Information</h4>
    </div>

    <div class="row">
      <div class="col-md-6 mb-2">
        <label class="form-label fw-medium">Name <span class="text-danger">*</span></label>
        <input type="text" name="name" class="form-control" placeholder="Full name" />
      </div>
      <div class="col-md-3 mb-2">
        <label class="form-label fw-medium">Age <span class="text-danger">*</span></label>
        <input type="number" name="age" class="form-control" placeholder="Age" />
      </div>
      <div class="col-md-3 mb-2">
        <label class="form-label fw-medium">Sex <span class="text-danger">*</span></label>
        <select name="sex" class="form-select">
          <option value="">Select</option>
          <option>Female</option>
          <option>Male</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <!-- SUBJECTIVE -->
    <div class="soap-section">
      <div class="soap-title">S – Subjective</div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label fw-medium"
            >Chief Complaint <span class="text-danger">*</span></label
          >
          <input type="text" name="chief_complaint" class="form-control" />
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label fw-medium">History of Present Illness</label>
          <textarea name="hpi" rows="3" class="form-control"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label fw-medium"
            >Past Medical History <span class="text-danger">*</span></label
          >
          <textarea name="pmh" rows="2" class="form-control"></textarea>
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label fw-medium">Family & Social History</label>
          <textarea name="family_social" rows="2" class="form-control"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="soap-body">
          <textarea
            placeholder="Chief complaint, duration, pain, symptoms, patient history, allergies..."
          ></textarea>
        </div>
      </div>

      <!-- OBJECTIVE -->
      <div class="soap-section">
        <div class="soap-title">O – Objective</div>
        <div class="row">
          <div class="col-md-6">
            <h6>Vital Signs</h6>
            <div class="row">
              <div class="col-6 mb-2">
                <label class="form-label fw-medium">Blood Pressure</label>
                <input type="text" name="bp" class="form-control" placeholder="e.g. 120/80 mmHg" />
              </div>
              <div class="col-6 mb-2">
                <label class="form-label fw-medium">Heart Rate</label>
                <input type="number" name="testhr" class="form-control" placeholder="bpm" />
              </div>
              <div class="col-6 mb-2">
                <label class="form-label fw-medium">Respiratory Rate</label>
                <input type="number" name="rr" class="form-control" placeholder="breaths/min" />
              </div>
              <div class="col-6 mb-2">
                <label class="form-label fw-medium">Temperature</label>
                <input type="text" name="temp" class="form-control" placeholder="°C / °F" />
              </div>
              <div class="col-6 mb-2">
                <label class="form-label fw-medium">Oxygen Saturation</label>
                <input type="text" name="spo2" class="form-control" placeholder="%" />
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <h6>Exam</h6>
            <div class="mb-2">
              <label class="form-label fw-medium">General Appearance</label>
              <input type="text" name="general_appearance" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label fw-medium">HEENT</label>
              <input type="text" name="heent" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label fw-medium">Neck</label>
              <input type="text" name="neck" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label fw-medium">Cardiovascular</label>
              <input type="text" name="cardio" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label fw-medium">Respiratory</label>
              <input type="text" name="respiratory" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label fw-medium">Other</label>
              <input type="text" name="other_exam" class="form-control" />
            </div>
          </div>
        </div>

        <div class="mb-2 mt-3">
          <label class="form-label fw-medium">Diagnostic Tests & Imaging (if available)</label>
          <textarea name="diagnostic_tests" rows="2" class="form-control"></textarea>
        </div>

        <div class="soap-body">
          <div class="grid">
            <input type="text" placeholder="BP (e.g. 120/80)" />
            <input type="text" placeholder="Pulse Rate" />
            <input type="text" placeholder="Temperature" />
            <input type="text" placeholder="SpO₂" />
            <input type="text" placeholder="Weight (kg)" />
            <input type="text" placeholder="Height (cm)" />
          </div>
          <textarea
            placeholder="Clinical findings, lab results, physical examination notes..."
          ></textarea>
        </div>
      </div>

      <!-- ASSESSMENT -->
      <div class="soap-section">
        <div class="soap-title">A – Assessment</div>
        <div class="soap-body">
          <textarea
            placeholder="Diagnosis, differential diagnosis, clinical impression..."
          ></textarea>
        </div>
        <div class="row">
          <div class="col-md-6 mb-2">
            <label class="form-label fw-medium">Primary Diagnoses</label>
            <textarea name="primary_dx" rows="2" class="form-control"></textarea>
          </div>
          <div class="col-md-6 mb-2">
            <label class="form-label fw-medium">Differential Diagnoses</label>
            <textarea name="diff_dx" rows="2" class="form-control"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-2">
            <label class="form-label fw-medium">Justification</label>
            <textarea name="justification" rows="2" class="form-control"></textarea>
          </div>
        </div>
      </div>

      <!-- PLAN -->
      <div class="soap-section">
        <div class="soap-title">P – Plan</div>
        <div class="soap-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label fw-medium">Medications & Dosages</label>
              <textarea name="medications" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label fw-medium">Lifestyle Modifications</label>
              <textarea name="lifestyle" rows="2" class="form-control"></textarea>
            </div>
          </div>
          <div class="row">
            <textarea
              placeholder="Treatment  test plan, prescribed medicines, dosage, advice, follow-up..."
            ></textarea>
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="action-bar">
          <button class="btn btn-secondary">Cancel</button>
          <button class="btn btn-primary">Save</button>
          <button class="btn btn-success">Save & Send to Pharmacy</button>
        </div>
      </div>
    </div>
  </div>
</div>
